---
dist: xenial
language: python
python: 3.7
# pre-commit hooks can use Docker, so we should go ahead and enable it
services: docker
env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "uFugW+oj87y8fyIYkzSiiPn7CwKoDPB/OjjcfUCuKbft4yWBMKeNj9g\
      j6nYF1VexVyYfyaWPWj+y7H8YOdHZ705dPXMDhexIrpfNsh9Tic31bMJnURj618O\
      l/KQ0lpvbS3YVkXv2lyRjcY+aEFvKdO5m0NjU1MIniRFChh/zjygSu4/teDmuuJh\
      afDkxtwNqXq4f30+MeLpL3R/7b6byF6Y6IvbT0fYjDcMgmQ5GHy5+ObCCXZEttm5\
      11zMTXdxotZ2qOO+nZSABlmwpTAK9a5DOzjFq/k8EyOWnbim7XBzcp9be4TQUi5u\
      u5mrldNZpYB0+BeEM9botjG4vnoj4HfORm2lolNeY0t14xdpieDx4kvFagdRobUW\
      0zjQhv8a1ZbomFdGlt4FjP+crB0PvTwf0/EykL7Eq9wK2n2hbkF/xWu5X8AGitI1\
      mO9uUHvE93lfTUSvl7zrxv8jS1OWWDfTghpfyW5Ec0UhDiYLEH3U2koJ3PQE2bCY\
      ElR/bfszznLKIoBAofJIO2kz2OuxGGlcS0n6HtXe9yuJkuaE8kdmkniIA5yBy7Uu\
      Ngh5hkmmtcVCTEHyxaC7KuWxsGpCAWOhclYS6v5nJ04rgDlzkvRnCd2mYVHFCtiO\
      NoQLC2n37QDqEjedo/ctFuR9Q+LcC8N57F3q/Rkfw+Z5qM7GIBKc="
    - AWS_DEFAULT_REGION="us-east-2"
    # AWS_SECRET_ACCESS_KEY
    - secure: "bxkWYDSu2A2v0Igmq0CYDvhMTmWbangPItHPJBWPd1eesa/XI/8dQ+C\
      bVW6BUcYsgYfUsR4dGCPZMzB0UQx0xrmA/mjqfGoktWZ26iEF37mppIpMKZLsWEC\
      1oskcThv2qr3gn7RaxbyWsoth5THK6Q0pos2LtPymGxxVgXINRPuqEc/cQXyRE3T\
      jXQ3JUx51PA9/b6G08pB21pXGCco6ZEpTZKehxJrKqrf6PDnanGONsxTV3UpilRu\
      wkHfGMbaOgXQ1328b4k/xoJFQBFDCjdi08e4p8OQoyWdUBWAcnw0iZyc8qpWv0rj\
      3Q3YOGCnsqUhNBphMk8bdkU/xS8vyK1anx0IuMS2VFu7CHgbU9kaQv70rPFOWVG8\
      crtkFTpXqE2iWuXQFDVC8L7IwbsP2DqhMu5X7h8sD3XnIjebAD1M5MpXZXVK5LY+\
      myR2Q2SfZQKm47ZEqR6Qh2TZkT651vhL0MGM+tiZ5oU9aPI5UCg2n0G+mx0rJWCr\
      PRuUhALrAkKhdLhZMKBKJ8EqYfsbVwHSRsffBNIcEvwZr97PqQXKzT/Ry7sD/a6y\
      qG5MgCZ84jL61IyVysfidmNx5/QI1ILaQt1c7gOz1IU8E/hhqOOab/W1tfgCHWdl\
      fLr9bXJBmpQcwAknbtZA+Vkt2UEL7H0pwF9oQjpTPWAApgNluc6g="
    - CURL_CACHE_DIR="$HOME/.cache/curl"
    # GITHUB_ACCESS_TOKEN
    - secure: "CMVLqC2AYZ78mEn8w1GWv3p7Ci5lProngCei/Fzin0KCYrsV+DEBQCm\
    6nKvv/wmEKIy79BpdF2GNwz23uiJXE8VF9A3WBM82coF5KfCO1CporqsQ25cLYSwCF\
    j8AxsT4n5JXHtXVsuNk0QETspZcDBjfOtdIS0p/YYArkpBS69NFJg4d7STcCPnIgRX\
    /06ksN9WRbliiiQ70gdkZpZE5ceqMH3mRiUFFKU9aTF2DnDDaYLVXbHqjtYL621HYa\
    /XywUQ6YZwFEbz8n4XwGqARILJOfz0FPJcKCOAnAnbGwY3ejef15lEMDZQuPzb7kPy\
    hhykpbNKY028781GyQxJrPMYx1AYOlAeP/vkFUGQvMXbOuEF6WLLv3CHsx1MX30EW3\
    bZL5FBgxwvg5v/PgFQNdh8Ma+e02D2p+AHWUCf3VhwHqdKovk3ebDRlF2geJYl8KP7\
    HiqSnKlITsvRxh+tZdvBR7rNv6+PjsjfR00hMI4KY45Z6eoLXcXz9icwT76Q1+Adnz\
    eMACE+Yb3HLdg4mfo6Ni3Fkdz+8ODw750crSsR1/TAGeFL8F+qp+1eqScMbz+vxoyv\
    yKDN3LCV3Sj6nmiE4d3UmjP/YKkQxD9cqCzBFMuUtJKgNajpbuy0WKdtkConb2wxSa\
    3bX4KmUdPpv1mLNg5ugcp+8PWT1/Bb0U2A="
    - PACKER_BUILD_REGION="us-east-2"
    - PACKER_DEPLOY_REGION_KMS_MAP="us-east-1:alias/cool/ebs,
                                    us-east-2:alias/cool/ebs,
                                    us-west-1:alias/cool/ebs,
                                    us-west-2:alias/cool/ebs"
    - PACKER_VERSION="1.4.3"
    - PACKER_ZIP="packer_${PACKER_VERSION}_linux_amd64.zip"
    - TERRAFORM_VERSION="0.12.7"
    - TERRAFORM_ZIP="terraform_${TERRAFORM_VERSION}_linux_amd64.zip"


# Cache pip packages, pre-commit plugins, and some curl downloads to
# speed up builds
cache:
  pip: true
  directories:
    - $HOME/.cache/pre-commit
    - $CURL_CACHE_DIR

before_install:
  # Make a cache directory for curl downloads
  - mkdir -p $CURL_CACHE_DIR
  # Install terraform
  - curl --output "${CURL_CACHE_DIR}/${TERRAFORM_ZIP}"
      --time-cond "${CURL_CACHE_DIR}/${TERRAFORM_ZIP}" --location
      "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/${TERRAFORM_ZIP}"
  - sudo unzip -d /opt/terraform "${CURL_CACHE_DIR}/${TERRAFORM_ZIP}"
  - sudo ln -s /opt/terraform/terraform /usr/bin/terraform
  # Install packer
  - curl --output "${CURL_CACHE_DIR}/${PACKER_ZIP}"
      --time-cond "${CURL_CACHE_DIR}/${PACKER_ZIP}" --location
      "https://releases.hashicorp.com/packer/${PACKER_VERSION}/${PACKER_ZIP}"
  - sudo unzip -o -d /usr/local/bin "${CURL_CACHE_DIR}/${PACKER_ZIP}"

install:
  - pip install --upgrade --requirement requirements-test.txt
  - export PACKER_IMAGE_VERSION=$(./bump_version.sh show)
  # Install roles
  - ansible-galaxy install --force --role-file src/requirements.yml

script:
  - pre-commit run --all-files
  - ./patch_packer_config.py query-github src/packer.json
  - packer validate src/packer.json
  - pytest

before_deploy:
  - pip install travis-wait-improved

deploy:
  # create an image when tagged
  - provider: script
    # preserve patch to packer configuration by skipping cleanup
    skip_cleanup: true
    script: travis-wait-improved --timeout=30m packer build --timestamp-ui
      src/packer.json
    on:
      tags: true
